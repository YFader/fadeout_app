import { migrate, client } from '../shared/db.js'; import { requireAuth } from '../shared/auth.js';
export default async function handler(req,res){ try{ await migrate(); requireAuth(req); const db=await client(); const roomId=req.query.roomId; const hours=Number(req.query.hours||1); const code=req.query.code; const room=(await db.query('SELECT hourly_rate_cents FROM rooms WHERE id=?',[roomId])).rows[0]; if(!room) return res.status(404).json({ error:'Комната не найдена' }); let base=room.hourly_rate_cents*hours; if(!code) return res.status(200).json({ valid:false, finalPriceCents: base, currency: process.env.CURRENCY||'RUB' }); const promo=(await db.query('SELECT * FROM promos WHERE code=?',[code])).rows[0]; if(!promo) return res.status(200).json({ valid:false, finalPriceCents: base, currency: process.env.CURRENCY||'RUB' }); if(promo.expires_at && new Date(promo.expires_at) < new Date()) return res.status(200).json({ valid:false, finalPriceCents: base, currency: process.env.CURRENCY||'RUB' }); if(promo.usage_limit && promo.used_count >= promo.usage_limit) return res.status(200).json({ valid:false, finalPriceCents: base, currency: process.env.CURRENCY||'RUB' }); const finalPriceCents = Math.round(base*(1 - promo.discount/100)); res.status(200).json({ valid:true, code:promo.code, discount:promo.discount, finalPriceCents, currency: process.env.CURRENCY||'RUB' }); } catch(e){ res.status(500).json({ error:e.message }); } }