import { migrate, client } from '../shared/db.js'; import { requireAuth } from '../shared/auth.js'; import { v4 as uuidv4 } from 'uuid';
export default async function handler(req,res){ try{ if(req.method!=='POST') return res.status(405).end(); await migrate(); const userId=requireAuth(req); const bookingId=req.query.bookingId; const db=await client(); const row=(await db.query('SELECT id FROM bookings WHERE id=? AND user_id=?',[bookingId,userId])).rows[0]; if(!row) return res.status(404).json({ error:'Бронь не найдена' }); const code=uuidv4(); await db.execute('INSERT INTO booking_invites (booking_id, invite_code) VALUES (?,?)',[bookingId,code]); res.status(200).json({ inviteLink: `https://t.me/FADEOUT_BOT/miniapp?startapp=invite-${code}` }); } catch(e){ res.status(500).json({ error:e.message }); } }